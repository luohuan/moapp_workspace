const cmd_handler=require("./cmd_handler.js");module.exports={sessionVersion:"v1.1",requestingSession:false,requestCloudFunction:function(e,t,a,o,s){var n=this;return new Promise((i,r)=>{const l=getApp();n.login(t).then(c=>{if(l.globalData.userInfo){s.app.userInfo=l.globalData.userInfo;delete l.globalData.userInfo}wx.request({url:`${l.globalData.domain}/cloud`,data:{session:c.sessionID,module:a,func_name:o,data:s},method:"POST",header:{"content-type":"application/json"},success:o=>{if("statusCode"in o&&o.statusCode!=200){wx.hideLoading();n.showAlert("错误提示",`糟糕,服务器出错了,错误码:${o.statusCode},请稍后重试...`);r({statusCode:o.statusCode,data:o.data})}else{if(o.data.ret==0){cmd_handler.execute(e,t,a,s,o.data.data,this);s.data=o.data.data;if("resolve"in o.data&&o.data.resolve===false){wx.hideLoading();r(s)}else{i(s)}}else{console.log(`Execute cloud function fail！error code:${o.data.ret}`);try{if(o&&o.data&&o.data.data&&"traceback"in o.data.data){console.log("---------error traceback---------:\n"+o.data.data.traceback)}if(o&&o.data&&o.data.data&&"error_message"in o.data.data){console.log("---------error message---------:\n"+o.data.data.error_message)}}catch(e){console.error(e)}wx.hideLoading();if(l.globalData.env=="release"){n.showAlert("错误提示",`出错了，错误码:${o.data.ret}`)}else{n.showAlert("错误提示",`出错了，错误码:${o.data.ret},\r\n 错误信息: `+(o.data.data.error_message||"无")+", 详细错误信息请参考微信开发者工具Console日志输出.")}r({errorCode:o&&o.data&&o.data.ret||-1,data:o&&o.data&&o.data.data||""})}}},fail:function(e){r(e)}})},e=>{n.showAlert("错误提示",`糟糕,服务器出错啦,请稍后重试...`);r("login fail")})})},genObjectDataName:(e,t)=>{return`__${e}_${t}`},submitFormId:function(e,t){const a=getApp();var o=a.globalData.sessionID;if(!o){return}wx.request({url:`${a.globalData.domain}/templateInfo`,data:{appid:e,formId:t,sessionID:o},method:"POST",header:{"content-type":"application/json"},success:function(e){},fail:function(e){}})},jsonToUrlParams:e=>{var t=[];for(var a in e){t.push(a+"="+encodeURIComponent(e[a]))}return t.join("&")},getUserInfo:()=>{return new Promise((e,t)=>{wx.getUserInfo({success:function(t){e(t.userInfo)},fail:function(t){e({})}})})},genEventData:function(e,t,a,o,s=null){const n=getApp();var i=[];if(a.data.objects){for(var r=0;r<a.data.objects.length;++r){var l=a.data.objects[r];var c={id:l,attrs:[]};var d=this.genObjectDataName(l,"");for(var u in a.data){if(u.slice(0,d.length)==d){var g=u.slice(d.length,u.length);if(g==="value"){c["value"]=a.data[u]}else if(g==="item"){c["currentItem"]=a.data[u].item}else{let e=false;for(let t in n.globalData.uiBaseAttr4Server){if(g==n.globalData.uiBaseAttr4Server[t]){e=true;break}}if(!e){c["attrs"].push(g)}}}}i.push(c)}}return{app:{scene:n.globalData.scene},page:{name:t,createTime:a.data.createTime,options:a.data.options||{},elements:i,data:a.data.serverData||{},currentTarget:{id:s?s.id||null:null}},data:o}},showConfirm:(e,t,a)=>{return new Promise((o,s)=>{wx.showModal({title:e||"提示",content:t||"",success:e=>{if(e.confirm){o(a)}else if(e.cancel){s(a)}},fail:e=>{console.log("showModal fail! err:");console.log(e);s(a)}})})},showAlert:(e,t)=>{wx.showModal({title:e||"提示",content:t||"",showCancel:false})},chooseImage:(e,t,a,o)=>{console.log(e);e.params={};return new Promise((s,n)=>{wx.chooseImage({count:t,sizeType:a,sourceType:o,success:function(t){console.log(t);console.log("发生了什么");e.params.tempFilePaths=t.tempFilePaths;console.log(e);s(e)}})})},checkAuthSetting:(e,t)=>{return new Promise((a,o)=>{let s=wx.getSetting({success:s=>{var n=s.authSetting;console.log(n);const i=e;if(i in n&&n[i]){a()}else{if(i in n){wx.showModal({title:"提示",content:t,success:t=>{if(t.confirm){wx.openSetting({success:t=>{console.log(t);if(e in t.authSetting&&t.authSetting[e]){a()}else{o()}}})}else{o()}},fail:e=>{o()}})}else{wx.authorize({scope:i,success(){a()},fail(){o()}})}}},fail:e=>{console.error("get setting fail!");o()}})})},saveImage:function(e,t){var a=this;e=e||{};return new Promise((o,s)=>{a.checkAuthSetting("scope.writePhotosAlbum",'您现在不允许小程序访问手机相册，不能保存到朋友圈，请打开"保存到相册"').then(()=>{wx.showLoading({title:"保存中"});wx.downloadFile({url:t,success:function(t){wx.saveImageToPhotosAlbum({filePath:t.tempFilePath,success:function(t){wx.hideLoading();a.showAlert("保存成功","已保存到相册，快去分享吧~");o(e)},fail:function(t){wx.showToast({title:"图片保存失败",icon:"none",duration:1500});s(e)}})},fail:function(t){wx.showToast({title:"图片下载失败",icon:"none",duration:1500});s(e)}})},()=>{wx.showToast({title:"图片保存失败",icon:"none",duration:1500});s(e)})})},wxLogin:function(e,t){console.log("re login");wx.login({success:function(a){if(a.code){e({openid:null,code:a.code})}else{console.log("wx.login fail!, err:"+a.errMsg);t(a.errMsg)}},fail:function(e){console.error("wx.login fail! err:"+e);t(e)}})},getWxCode:function(){var e=this;return new Promise((t,a)=>{var o=e.getOpenId();if(o&&e.sessionVersion==wx.getStorageSync("version")){wx.checkSession({success:function(){t({openid:o,code:null})},fail:function(){console.log("session is invalid, relogin");e.wxLogin(t,a)}})}else{e.wxLogin(t,a)}})},login:function(e){var t=this;return new Promise((a,o)=>{const s=getApp();if(s.globalData.sessionID){a({sessionID:s.globalData.sessionID})}else{if(!t.requestingSession){t.requestingSession=true;t.getWxCode().then(n=>{wx.request({url:`${s.globalData.domain}/session`,data:{appid:e,signature:s.globalData.signature,userInfo:{},code:n["code"],openid:n["openid"],uiBaseAttr:s.globalData.uiBaseAttr4Server,sysInfo:wx.getSystemInfoSync()||{}},method:"POST",header:{"content-type":"application/json"},success:e=>{if("statusCode"in e&&e.statusCode!=200){o("login fail!")}else{s.globalData.sessionID=e.data.data.sessionID;wx.setStorage({key:"openid",data:e.data.data["openid"]});wx.setStorage({key:"version",data:t.sessionVersion});console.log(`get session: ${s.globalData.sessionID}, openid:${e.data.data["openid"]}`);a(e.data.data)}},fail:e=>{console.error("login failed");console.error(e);o(e)},complete:e=>{t.requestingSession=false}})})}else{let e=setInterval(()=>{if(!t.requestingSession){clearInterval(e);a({sessionID:s.globalData.sessionID})}},100)}}})},appBgmAllInOne:e=>{if(wx.createInnerAudioContext){e.bgm=wx.createInnerAudioContext();e.soundEffect=wx.createInnerAudioContext();e.bgm.onPlay(()=>{}),e.bgm.onPause(()=>{}),e.bgm.onStop(()=>{}),e.bgm.onEnded(()=>{}),e.soundEffect.onStop(()=>{}),e.soundEffect.onEnded(()=>{})}else{wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。"})}},bgmControl:(e,t)=>{if(wx.createInnerAudioContext){if(e.data.bgmstate[0]==1){if(!e.data.bgmstate[1]){t.bgm.pause();e.setData({bgmstate:[1,1]})}else{t.bgm.play();e.setData({bgmstate:[1,0]})}}}},bgmAllInOne:(e,t)=>{if(wx.createInnerAudioContext){e.setData({bgmcontrol:t.bgm.control||false,controlStyle:t.bgm.controlStyle||false,bgmstate:[t.bgm.src==(""||"http://null")?0:1,+t.bgm.paused],soundEffectState:[t.soundEffect.src==(""||"http://null")?0:1,+t.soundEffect.paused]})}},getOpenId:()=>{return wx.getStorageSync("openid")},setTitle:e=>{const t=getApp();if(t.globalData.env!="release"){e=e+"-测试版"}wx.setNavigationBarTitle({title:e})},setUserData:(e,t,a)=>{var o=e.sessionID;const s=getApp();return new Promise((e,n)=>{wx.request({url:`${s.globalData.domain}/userdata`,method:"POST",data:{sessionID:o,key:t,value:a},success:function(t){t.data.sessionID=o;e(t.data)},fail:function(e){n(e)}})})},getUserData:(e,t)=>{var a=e.sessionID;const o=getApp();return new Promise((e,s)=>{wx.request({url:`${o.globalData.domain}/userdata`,method:"GET",data:{sessionID:a,key:t},success:function(t){t.data.sessionID=a;e(t.data)},fail:function(e){s(e)}})})}};