const util=require("./util.js");module.exports={__setTitle(a,e,o){a.moapp.setTitle(e)},__setAttr(a,e,o){o[a.moapp.genObjectDataName(e.id,e.key)]=e.value},__goto(a,e,o){let t=util.jsonToUrlParams(e.options||{});wx.navigateTo({url:`../${e.page_name}/${e.page_name}?${t}`})},__redirectTo(a,e,o){let t=util.jsonToUrlParams(e.options||{});wx.redirectTo({url:`../${e.page_name}/${e.page_name}?${t}`})},__switchTab(a,e,o){wx.switchTab({url:`../${e.page_name}/${e.page_name}`})},__goBack(a,e,o){wx.navigateBack({delta:1})},__setNavibarColor(a,e,o){wx.setNavigationBarColor({frontColor:e.frontColor=="#000000"?"#000000":"#ffffff",backgroundColor:e.backgroundColor||"#ffffff"})},__showAlert(a,e,o){a.moapp.showAlert(e.title,e.content)},__showConfirm(a,e,o){wx.showModal({title:e.title||"提示",content:e.content||"",success:o=>{if(o.confirm){a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.confirm.function,a.params)}else if(o.cancel){a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.cancel.function,a.params)}},fail:a=>{console.log("showModal fail! err:");console.log(a)}})},__showTips(a,e,o){wx.showToast({title:e.text,icon:"success",image:e.image,duration:e.duration})},__gotoMiniProgram(a,e,o){wx.navigateToMiniProgram({appId:e.appid,path:e.path,success:function(a){console.log("跳转小程序成功")},fail:function(a){console.log("跳转小程序失败，错误信息:");console.log(a)}})},__saveImage(a,e,o){a.moapp.saveImage(null,e).then().catch(()=>{})},__appendData(a,e,o){let t=a.moapp.genObjectDataName(e.id,"data");let n=a.page_obj.data[t];n.push(e.value);o[t]=n},__console(a,e,o){console.log(e.content)},__previewImage(a,e,o){wx.previewImage({urls:e})},__wxpay(a,e,o){if(e.params){let o=e.params;wx.requestPayment({timeStamp:o.timeStamp,nonceStr:o.nonceStr,package:o.package,signType:o.signType,paySign:o.paySign,success:function(o){a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.success.function,a.params)},fail:function(o){console.log(o);let t=o.errMsg.indexOf("cancel")>-1;if(a.params.params){a.params.params.wxpayCancel=t}else{a.params.params={wxpayCancel:t}}a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.fail.function,a.params)}})}else{if(e.fail){a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.fail.function,a.params)}console.error("invalid wxpay params:",e)}},__openWeb(a,e,o){let t=e.url;let n=a.moapp.getOpenId();const s=getApp();var p=s.globalData.sessionID;let l=encodeURIComponent(`${s.globalData.domain}/cloud`);let i=`openid=${n}&sessionid=${p}&interface=${l}`;if(t.indexOf("?")>-1){t=t+"&"+i}else{t=t+"?"+i}console.log(t);wx.navigateTo({url:"../__web_page/web_page?url="+encodeURIComponent(t)})},__makePhoneCall(a,e,o){wx.makePhoneCall({phoneNumber:e.phone_number})},__getWeRunData(a,e,o){a.moapp.checkAuthSetting("scope.werun",'小程序需要读取您的微信运动数据，请打开"微信运动步数"').then(()=>{wx.getWeRunData({success(o){a.params.encrypted_data={type:"weRunData",data:o.encryptedData,iv:o.iv};a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.success.function,a.params)},fail(o){console.error("get wx run data fail!",o);a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.fail.function,a.params)}})},o=>{a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.fail.function,a.params)})},getImageInfo(a){return new Promise((e,o)=>{wx.getImageInfo({src:a,success:function(a){console.log(a.width);console.log(a.height);e([a.width,a.height])}})})},__uploadImage(a,e,o){var t=this;console.log("uploadImage");var n=e;wx.chooseImage({count:n.count,sizeType:["original","compressed"],sourceType:n.sourceType,sizeType:n.sizeType,success:function(e){wx.showLoading({title:"上传中0/"+e.tempFilePaths.length});var o=e.tempFilePaths;var t=o.length;var s=0;var p=[];var l=[];var i=0;var r=0;const c=getApp();for(var m=0;m<t;m++){(function(e){wx.getImageInfo({src:o[e],success:function(m){console.log(m.width);console.log(m.height);console.log(o);wx.uploadFile({url:`${c.globalData.upload}`,filePath:o[e],name:"file",formData:{appid:a.appid},success:function(a){var e=JSON.parse(a.data);if(a.statusCode==200&&e.ret==0){s+=1;r+=1;p.push(e.url);l.push({width:m.width,height:m.height,orientation:m.orientation,type:m.type});wx.showLoading({title:"上传中"+s+"/"+o.length})}else{r+=1;i+=1}},fail:function(){r+=1;i+=1},complete:function(){if(r==t){console.log(a.params);a.params.params={};a.params.params.urls=p;a.params.params.images=p;console.log(l);a.params.params.imagesInfo=l;a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,n.success.function,a.params);wx.hideLoading();wx.showToast({title:"上传完成"})}}})}})})(m)}},fail:function(){console.log("选择图片失败");a.moapp.requestCloudFunction(a.page_obj,a.appid,a.module_name,e.fail.function,a.params)}})},__playBGM(a,e,o){const t=getApp();if(wx.createInnerAudioContext){var n=Date.now();t.bgm.src=e.src+`#${n}`;t.bgm.control=e.control;t.bgm.controlStyle="bgm-"+e.controlStyle;t.bgm.title="bgm";t.bgm.autoplay=e.autoplay;t.bgm.loop=e.loop;o.bgmcontrol=+t.bgm.control;o.bgmstate=[1,+!t.bgm.autoplay];o.controlStyle=t.bgm.controlStyle}},__pauseBGM(a,e,o){const t=getApp();if(a.page_obj.data.bgmstate&&a.page_obj.data.bgmstate[0]==1){t.bgm.pause();o.bgmstate=[1,1]}},__resumeBGM(a,e,o){const t=getApp();if(a.page_obj.data.bgmstate&&a.page_obj.data.bgmstate[0]==1){t.bgm.pause();o.bgmstate=[1,0]}},__closeBGM(a,e,o){const t=getApp();if(a.page_obj.data.bgmstate&&a.page_obj.data.bgmstate[0]==1){t.bgm.src="http://null";t.bgm.control=false;t.bgm.stop();o.bgmstate=[0,1];o.bgmcontrol=0}},__playAudio(a,e,o){const t=getApp();if(wx.createInnerAudioContext){var n=Date.now();t.soundEffect.src=e.src+`#${n}`;t.soundEffect.autoplay=true;o.soundEffectState=[1,0]}},execute:function(a,e,o,t,n,s){const p=getApp();var l=s;var i={};var r={};for(var c in n){var m=n[c];var u=m.cmd;var g="__"+u;if(g in this){var d=m.data;this[g]({page_obj:a,appid:e,moapp:s,module_name:o,params:t},d,i)}else{var d=m.data;switch(u){case"setData":r[d.key]=d.value;break;default:console.log("invalid server cmd:"+u);break}}}if(JSON.stringify(r)!="{}"){var f=a.data.serverData||{};for(var _ in r){f[_]=r[_]}i["serverData"]=f}if(JSON.stringify(i)!="{}"&&a){a.setData(i)}}};