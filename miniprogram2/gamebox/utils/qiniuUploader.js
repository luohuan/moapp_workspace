(function(){var e={qiniuRegion:"",qiniuImageURLPrefix:"",qiniuUploadToken:"",qiniuUploadTokenURL:"",qiniuUploadTokenFunction:null,qiniuShouldUseQiniuFileName:false};module.exports={init:n,upload:o};function n(n){e={qiniuRegion:"",qiniuImageURLPrefix:"",qiniuUploadToken:"",qiniuUploadTokenURL:"",qiniuUploadTokenFunction:null,qiniuShouldUseQiniuFileName:false};i(n)}function i(n){if(n.region){e.qiniuRegion=n.region}else{console.error("qiniu uploader need your bucket region")}if(n.uptoken){e.qiniuUploadToken=n.uptoken}else if(n.uptokenURL){e.qiniuUploadTokenURL=n.uptokenURL}else if(n.uptokenFunc){e.qiniuUploadTokenFunction=n.uptokenFunc}if(n.domain){e.qiniuImageURLPrefix=n.domain}e.qiniuShouldUseQiniuFileName=n.shouldUseQiniuFileName}function o(n,o,a,r){if(null==n){console.error("qiniu uploader need filePath to upload");return}if(r){i(r)}if(e.qiniuUploadToken){u(n,o,a,r)}else if(e.qiniuUploadTokenURL){l(function(){u(n,o,a,r)})}else if(e.qiniuUploadTokenFunction){e.qiniuUploadToken=e.qiniuUploadTokenFunction();if(null==e.qiniuUploadToken&&e.qiniuUploadToken.length>0){console.error("qiniu UploadTokenFunction result is null, please check the return value");return}}else{console.error("qiniu uploader need one of [uptoken, uptokenURL, uptokenFunc]");return}}function u(n,i,o,u){if(null==e.qiniuUploadToken&&e.qiniuUploadToken.length>0){console.error("qiniu UploadToken is null, please check the init config or networking");return}var l=a(e.qiniuRegion);var r=n.split("//")[1];if(u&&u.key){r=u.key}var t={token:e.qiniuUploadToken};if(!e.qiniuShouldUseQiniuFileName){t["key"]=r}console.log("xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|"+l+"|xxxxxxxxxxxxxxxxxxxxx");wx.uploadFile({url:l,filePath:n,name:"file",formData:t,success:function(n){var u=n.data;try{var l=JSON.parse(u);var a=e.qiniuImageURLPrefix+"/"+l.key;l.imageURL=a;console.log(l);if(i){i(l)}}catch(e){console.log("parse JSON failed, origin String is: "+u);if(o){o(e)}}},fail:function(e){console.error(e);if(o){o(e)}}})}function l(n){wx.request({url:e.qiniuUploadTokenURL,success:function(i){var o=i.data.uptoken;if(o&&o.length>0){e.qiniuUploadToken=o;if(n){n()}}else{console.error("qiniuUploader cannot get your token, please check the uptokenURL or server")}},fail:function(e){console.error("qiniu UploadToken is null, please check the init config or networking: "+e)}})}function a(e){var n=null;switch(e){case"ECN":n="https://up.qbox.me";break;case"NCN":n="https://up-z1.qbox.me";break;case"SCN":n="https://up-z2.qbox.me";break;case"NA":n="https://up-na0.qbox.me";break;default:console.error("please make the region is with one of [ECN, SCN, NCN, NA]")}return n}})();